<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
		<title>地图显示</title>

		<style>
			html,
			body,
			#container {
				width: 100%;
				height: 100%;
			}
		</style>

	</head>
	<body>

		<div id="container"></div>
		<div id="showMessage" class="input-card" style="width: 16rem;">
			<h4>移动轨迹记录&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DouLi</h4>
			<div>
				<div class="input-item">
					<button class="btn" style="margin-right: 1rem;" onclick="beginRecord()">开始记录</button>
					<button class="btn" style="margin-right: 1rem;" onclick="endRecord()">暂停记录</button>
				</div>
			</div>
			<h4 id="countCoord">已记录0个坐标点</h4>
		</div>

		<!-- 加载地图JSAPI脚本 -->
		<script src="https://webapi.amap.com/maps?v=1.4.15&key=c115600ea7b008f10715673a92966e1f"></script>
		<!-- 显示加载完成的脚本 -->
		<script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>

		<script type="text/javascript">
			var coordinates = [];
			var timer;
			var interval_time = 5000;
			var countCoord = document.getElementById("countCoord");
			
			window.onload = function(){
				getCoord();
			};

			// 构造坐标函数
			function CreatCoord(longitude, latitude) {
				this.longitude = longitude;
				this.latitude = latitude;
			}

			var map = new AMap.Map('container', {
				resizeEnable: true, //是否监控地图容器尺寸变化
				zoom: 20, //初始化地图层级
				center: [116.397428, 39.90923] //初始化地图中心点
			});
			map.on("complete", function() {
				log.info("地图加载完成！");
			});

			// 定时获取位置并添加标记(30s)
			function beginRecord(){
				// 开始记录
				timer = setInterval(function(){
					getCoord();
					countCoord.innerText = "已记录" + coordinates.length + "个坐标点"
				},interval_time);
				console.log("开始记录");
			};
			function endRecord(){
				// 停止记录
				clearInterval(timer);
				console.log("暂停记录");
			}
			
			// 获取定位
			function getCoord(){
				AMap.plugin('AMap.Geolocation', function() {
					var geolocation = new AMap.Geolocation({
						enableHighAccuracy: true, //是否使用高精度定位，默认:true
						timeout: 10000, //超过10秒后停止定位，默认：5s
						buttonPosition: 'RB', //定位按钮的停靠位置
						buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
						zoomToAccuracy: true, //定位成功后是否自动调整地图视野到定位点
						
						showButton: true,//是否显示定位按钮
						buttonPosition: 'LB',//定位按钮的位置
						/* LT LB RT RB */
						showMarker: false,//是否显示定位点
						markerOptions:{//自定义定位点样式，同Marker的Options
						  'offset': new AMap.Pixel(-18, -36),
						  'content':'<img src="https://a.amap.com/jsapi_demos/static/resource/img/user.png" style="width:36px;height:36px"/>'
						},
						showCircle: false,//是否显示定位精度圈
						'circleOptions': {//定位精度圈的样式
							'strokeColor': '#0093FF',
							'noSelect': true,
							'strokeOpacity': 0.2,
							'strokeWeight': 0.2,
							'fillColor': '#02B0FF',
							'fillOpacity': 0.25
						}
					});
					map.addControl(geolocation);
					geolocation.getCurrentPosition(function(status, result) {
						if (status == 'complete') {
							onComplete(result)
						} else {
							onError(result)
						}
					});
				});
			}			
			//解析定位结果
			function onComplete(data) {
				console.log('定位成功');
				var str = [];
				str.push('定位结果：' + data.position);
				str.push('定位类别：' + data.location_type);
				if (data.accuracy) {
					str.push('精度：' + data.accuracy + ' 米');
				} //如为IP精确定位结果则没有精度信息
				str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
				console.log(str);
				// 将位置存入数组
				var coord = new CreatCoord(data.position.R, data.position.Q);
				addMarker(data.position.R, data.position.Q);
				coordinates.push(coord);
				console.log(coordinates);
			}
			//解析定位错误信息
			function onError(data) {
				console.log('定位失败');
				console.log('失败原因排查信息:' + data.message);
			}


			// 实例化点标记
			function addMarker(longitude,latitude) {
				marker = new AMap.Marker({
					content:'<img src="https://a.amap.com/jsapi_demos/static/resource/img/user.png" style="width:36px;height:36px"/>',
					position: [longitude , latitude],
					offset: new AMap.Pixel(-13, -30)
				});
				marker.setMap(map);
			}
			// 更换图标
			function updateIcon(){
				marker.setIcon('//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png')
			}
			function updateContent() {

				if (!marker) {
					return;
				}

			 // 自定义点标记内容
				var markerContent = document.createElement("div");

				// 点标记中的图标
				var markerImg = document.createElement("img");
				markerImg.className = "markerlnglat";
				markerImg.src = "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png";
				markerContent.appendChild(markerImg);

				// 点标记中的文本
				var markerSpan = document.createElement("span");
				markerSpan.className = 'marker';
				markerSpan.innerHTML = "Hi，我被更新啦！";
				markerContent.appendChild(markerSpan);

				marker.setContent(markerContent); //更新点标记内容
				marker.setPosition([116.391467, 39.927761]); //更新点标记位置
			}
			// 清除 marker
			function clearMarker() {

				if (marker) {
					marker.setMap(null);
					marker = null;
				}
			}
			
			// 添加线 https://lbs.amap.com/demo/javascript-api/example/line/line3d
			
		</script>

	</body>
</html>
